# 🔒 安全建议和最佳实践

## ⚠️ 当前安全状态

**现状**：代码中包含硬编码的 API Keys 和 Supabase Keys 作为 fallback 值。

**风险等级**：🟡 **中等风险**

---

## 📋 当前风险分析

### 1. 代码仓库暴露风险

**风险**：
- 如果代码被推送到公开的 GitHub 仓库，API Keys 会被暴露
- 任何人都可以查看和使用这些密钥
- 可能导致：
  - API 配额被滥用
  - 产生意外费用
  - 数据泄露

**缓解措施**：
- ✅ `.env` 文件已在 `.gitignore` 中（不会被提交）
- ⚠️ 但硬编码的密钥仍然在源代码中
- ⚠️ 如果代码被提交，密钥会暴露

### 2. API Key 滥用风险

**风险**：
- 如果密钥泄露，他人可能：
  - 使用你的 Google Maps API 配额
  - 访问你的 Supabase 数据库（如果权限配置不当）
  - 产生意外费用

**缓解措施**：
- ✅ Supabase Anon Key 权限有限（通过 RLS 保护）
- ⚠️ Google Maps API Key 需要配置限制

---

## 🛡️ 安全建议（按优先级）

### 🔴 高优先级（立即执行）

#### 1. 配置 Google Maps API Key 限制

**为什么重要**：防止 API Key 被滥用，减少费用风险。

**操作步骤**：

1. **登录 Google Cloud Console**
   - 访问：https://console.cloud.google.com
   - 选择你的项目

2. **找到你的 API Key**
   - 进入 **APIs & Services** → **Credentials**
   - 找到使用的 API Key（如 `AIzaSyBQXxGLGseV9D0tXs01IaZlim6yksYG3mM`）

3. **配置 HTTP referrer 限制**
   - 点击 API Key 进行编辑
   - 在 **Application restrictions** 中选择 **HTTP referrers**
   - 添加允许的域名：
     ```
     https://market-link-express.com/*
     https://admin-market-link-express.com/*
     https://*.netlify.app/*
     http://localhost:*
     ```
   - 保存更改

4. **配置 API 限制**
   - 在 **API restrictions** 中选择 **Restrict key**
   - 只启用必要的 API：
     - ✅ Maps JavaScript API
     - ✅ Places API
     - ✅ Geocoding API
   - 保存更改

**预期效果**：
- ✅ 只有指定域名的网站可以使用此 API Key
- ✅ 即使密钥泄露，也无法在其他网站使用
- ✅ 减少费用风险

---

#### 2. 配置 Supabase Row Level Security (RLS)

**为什么重要**：即使 Anon Key 泄露，也无法访问未授权的数据。

**操作步骤**：

1. **登录 Supabase Dashboard**
   - 访问：https://app.supabase.com
   - 选择你的项目

2. **检查 RLS 策略**
   - 进入 **Authentication** → **Policies**
   - 确认所有表都启用了 RLS

3. **创建/更新 RLS 策略**
   - 为每个表创建适当的策略
   - 例如，`packages` 表：
     ```sql
     -- 用户只能查看自己的订单
     CREATE POLICY "Users can view own packages"
     ON packages FOR SELECT
     USING (auth.uid()::text = customer_id);
     ```

**预期效果**：
- ✅ 即使 Anon Key 泄露，也无法访问未授权的数据
- ✅ 数据访问受 RLS 策略控制

---

#### 3. 监控 API 使用情况

**为什么重要**：及时发现异常使用，防止费用超支。

**操作步骤**：

1. **Google Cloud Console**
   - 进入 **APIs & Services** → **Dashboard**
   - 设置使用量警报
   - 监控每日/每月使用量

2. **Supabase Dashboard**
   - 进入 **Project Settings** → **Usage**
   - 监控数据库使用量
   - 设置使用量警报

**预期效果**：
- ✅ 及时发现异常使用
- ✅ 防止意外费用

---

### 🟡 中优先级（建议执行）

#### 4. 定期轮换 API Keys

**为什么重要**：即使密钥泄露，定期更换可以降低风险。

**建议频率**：
- Google Maps API Key：每 6-12 个月
- Supabase Keys：每 12 个月（如果怀疑泄露，立即更换）

**操作步骤**：

1. **生成新密钥**
   - Google Cloud Console：创建新的 API Key
   - Supabase Dashboard：生成新的 Anon Key

2. **更新环境变量**
   - Netlify Dashboard：更新环境变量
   - EAS Secrets：更新 EAS Secrets
   - 本地 `.env` 文件：更新本地配置

3. **禁用旧密钥**
   - 等待新密钥生效后（24-48小时）
   - 禁用或删除旧密钥

---

#### 5. 使用不同的 API Keys 用于不同环境

**为什么重要**：隔离开发和生产环境，降低风险。

**建议**：
- **开发环境**：使用限制较少的 API Key（仅用于 localhost）
- **生产环境**：使用严格限制的 API Key（仅用于生产域名）

**操作步骤**：

1. **创建两个 API Keys**
   - `dev-api-key`：用于开发环境
   - `prod-api-key`：用于生产环境

2. **配置不同的限制**
   - Dev Key：允许 `http://localhost:*`
   - Prod Key：只允许生产域名

3. **在不同环境使用不同密钥**
   - 本地开发：使用 Dev Key
   - Netlify：使用 Prod Key

---

#### 6. 代码审查和访问控制

**为什么重要**：防止意外泄露密钥。

**建议**：
- ✅ 限制 GitHub 仓库访问权限
- ✅ 使用私有仓库（如果可能）
- ✅ 代码审查时注意检查是否包含密钥
- ✅ 使用 `.gitignore` 排除敏感文件

---

### 🟢 低优先级（可选）

#### 7. 使用密钥管理服务

**为什么重要**：更安全的密钥管理方式。

**可选方案**：
- **AWS Secrets Manager**
- **Google Secret Manager**
- **HashiCorp Vault**

**适用场景**：
- 大型项目
- 多个环境
- 需要审计日志

---

## 📊 安全检查清单

### 立即检查（今天）

- [ ] Google Maps API Key 是否配置了 HTTP referrer 限制？
- [ ] Google Maps API Key 是否配置了 API 限制？
- [ ] Supabase 是否启用了 RLS？
- [ ] 是否设置了 API 使用量警报？

### 本周检查

- [ ] 是否创建了不同环境的 API Keys？
- [ ] 是否配置了 Supabase RLS 策略？
- [ ] 是否检查了 GitHub 仓库的访问权限？

### 定期检查（每月）

- [ ] 检查 API 使用量是否正常
- [ ] 检查是否有异常访问
- [ ] 审查代码中是否包含新的硬编码密钥

---

## 🚨 如果密钥泄露了怎么办？

### 立即行动步骤

1. **立即禁用泄露的密钥**
   - Google Cloud Console：禁用 API Key
   - Supabase Dashboard：生成新的 Anon Key

2. **生成新密钥**
   - 创建新的 API Keys
   - 更新所有环境变量

3. **检查异常活动**
   - 查看 API 使用日志
   - 检查是否有异常请求
   - 检查费用是否异常

4. **通知相关方**
   - 如果涉及客户数据，可能需要通知客户
   - 如果涉及支付，检查是否有异常交易

5. **加强安全措施**
   - 重新审查安全配置
   - 加强访问控制
   - 考虑使用密钥管理服务

---

## 📚 相关资源

### Google Cloud Console
- [API Key 最佳实践](https://cloud.google.com/docs/authentication/api-keys)
- [API Key 限制配置](https://cloud.google.com/docs/authentication/api-keys#restricting_api_keys)

### Supabase
- [Row Level Security 文档](https://supabase.com/docs/guides/auth/row-level-security)
- [安全最佳实践](https://supabase.com/docs/guides/platform/security)

### 一般安全
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [API 安全最佳实践](https://cheatsheetseries.owasp.org/cheatsheets/REST_Security_Cheat_Sheet.html)

---

## 💡 总结

虽然当前代码包含硬编码的 API Keys，但通过以下措施可以显著降低风险：

1. ✅ **配置 API Key 限制**（最重要）
2. ✅ **启用 Supabase RLS**
3. ✅ **监控 API 使用情况**
4. ✅ **定期轮换密钥**
5. ✅ **使用不同环境的密钥**

**记住**：安全是一个持续的过程，不是一次性的任务。定期审查和更新安全措施非常重要。

---

## ❓ 常见问题

### Q: 硬编码的密钥真的那么危险吗？

**A**: 是的，如果代码被推送到公开仓库，任何人都可以看到和使用这些密钥。即使仓库是私有的，团队成员也可能泄露密钥。

### Q: 如果我已经配置了 API Key 限制，还需要移除硬编码吗？

**A**: 配置限制可以降低风险，但最佳实践是完全移除硬编码，只使用环境变量。

### Q: 我应该多久检查一次安全配置？

**A**: 建议每月检查一次 API 使用情况，每季度审查一次安全配置。

### Q: 如果我的应用很小，还需要这么严格的安全措施吗？

**A**: 是的，即使是小应用也可能产生意外费用或被滥用。基本的安全措施（API Key 限制、RLS）应该始终实施。

