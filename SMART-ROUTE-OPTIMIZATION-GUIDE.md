# 🗺️ 智能路线优化系统使用指南

## 📋 功能概述

为骑手实现**智能路线规划**，自动优化配送顺序，优先派送距离最近的包裹，并考虑配送速度（急送达、定时达）优先级。

---

## 🎯 优化算法逻辑

### **核心思想**
类似于**旅行商问题 (TSP)** 的贪心解法，采用**最近邻算法 (Nearest Neighbor Algorithm)** + **优先级评分**。

### **算法步骤**

#### **步骤1：计算每个包裹的初始优先级**
```typescript
优先级分数 = 距离 × 速度权重

速度权重：
- 急送达：0.5 (优先级提高50%)
- 定时达：根据剩余时间动态调整
  - 剩余 < 1小时：0.3 (优先级最高)
  - 剩余 < 2小时：0.6 (优先级提高)
  - 其他：1.0 (正常)
- 准时达：1.0 (正常)
```

**示例**：
- 包裹A：距离10km，准时达 → 优先级 = 10 × 1.0 = **10**
- 包裹B：距离5km，急送达 → 优先级 = 5 × 0.5 = **2.5** ⭐
- 包裹C：距离8km，定时达(30分钟后) → 优先级 = 8 × 0.3 = **2.4** ⭐⭐

**结果**：优先派送 C → B → A

---

#### **步骤2：使用贪心算法优化路线**

```
当前位置 = 骑手位置 (C)
待配送包裹 = [A(10km), B(5km), D(3km)]

循环：
  1. 找到距离当前位置最近的包裹
  2. 考虑优先级调整（急送达权重×0.7）
  3. 将最近包裹加入路线
  4. 更新当前位置为该包裹位置
  5. 重复直到所有包裹都加入路线

示例执行：
- 起点：C
- 找最近：D(3km) ← 最近
- 路线：[D]，当前位置 = D
- 找最近：B(从D到B = 4km) ← 最近
- 路线：[D, B]，当前位置 = B
- 找最近：A(从B到A = 7km) ← 唯一剩余
- 路线：[D, B, A]
- 最终路线：C → D → B → A ✅
```

---

## 🔧 技术实现

### **1. 哈弗辛公式 (Haversine Formula)** - 计算两点距离

```typescript
const calculateDistance = (lat1, lon1, lat2, lon2): number => {
  const R = 6371; // 地球半径（公里）
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = 
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
};
```

### **2. Google Geocoding API** - 地址转坐标

```typescript
const parseCoordinatesFromAddress = async (address: string) => {
  const response = await fetch(
    `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=YOUR_API_KEY`
  );
  const data = await response.json();
  return data.results[0].geometry.location; // { lat, lng }
};
```

### **3. 优先级评分函数**

```typescript
let priorityScore = distance;

// 急送达优先
if (delivery_speed === '急送达') {
  priorityScore *= 0.5;
}

// 定时达根据剩余时间调整
if (delivery_speed === '定时达') {
  const hoursLeft = (scheduledTime - now) / (1000 * 60 * 60);
  if (hoursLeft < 1) priorityScore *= 0.3;
  else if (hoursLeft < 2) priorityScore *= 0.6;
}
```

---

## 📱 用户界面

### **包裹列表显示**

优化后的包裹列表会显示：

```
🗺️ 配送路线

📦 配送顺序 (3)

┌────────────────────────────────────────┐
│ ① PKG001  [⚡ 急送达]                  │
│ 📍 张三                                 │
│ 仰光市中心XXX路123号                    │
│ [配送中] 标准件 · 2kg  📏 2.5km         │
│                               [🗺️ 导航] │
└────────────────────────────────────────┘

┌────────────────────────────────────────┐
│ ② PKG002  [⏰ 定时达]                  │
│ 📍 李四                                 │
│ 曼德勒YYY街456号                        │
│ [已取件] 文件 · 0.5kg  📏 3.2km         │
│                               [🗺️ 导航] │
└────────────────────────────────────────┘

┌────────────────────────────────────────┐
│ ③ PKG003  [✓ 准时达]                   │
│ 📍 王五                                 │
│ 内比都ZZZ大道789号                      │
│ [已取件] 易碎品 · 3kg  📏 8.5km         │
│                               [🗺️ 导航] │
└────────────────────────────────────────┘

🧭 规划路线 (3站)
```

### **配送速度标识**

- **⚡ 急送达**：黄色背景，橙色边框，最高优先级
- **⏰ 定时达**：根据时间紧迫度自动调整优先级
- **✓ 准时达**：标准优先级

---

## 🚀 使用步骤

### **第一步：登录骑手账号**
1. 打开 **ML Express 移动应用**
2. 使用骑手账号登录
3. 确保已授予**位置权限**

### **第二步：查看待配送包裹**
1. 点击首页的 **"🗺️ 配送路线"**
2. 系统会自动加载你的待配送包裹
3. 包裹按**原始顺序**显示（未优化）

### **第三步：启动智能路线规划**
1. 点击屏幕底部的 **"🧭 规划路线 (N站)"** 按钮
2. 系统会显示提示：**"🔄 路线规划中... 正在为您优化最佳配送路线，请稍候"**
3. 稍等几秒（系统正在计算坐标和距离）

### **第四步：查看优化后的路线**
1. 包裹列表会**自动重新排序**
2. 每个包裹显示：
   - **序号**（①②③...）= 建议配送顺序
   - **距离**（📏 2.5km）= 距离当前位置的直线距离
   - **配送速度标识**（⚡⏰✓）
3. **最近且最紧急**的包裹会排在最前面

### **第五步：开始导航**
1. 点击第一个包裹卡片右侧的 **"🗺️ 导航"** 按钮
2. 或点击底部 **"🧭 规划路线"** 按钮打开 Google Maps 多点路线
3. Google Maps 会显示完整的配送路线，包含所有途经点

---

## 📊 优化效果示例

### **优化前（按订单时间排序）**
```
起点：C (骑手位置)
包裹顺序：A(10km) → B(5km) → D(3km)
总距离：10 + 8 + 5 = 23km
预计时间：46分钟
```

### **优化后（智能路线）**
```
起点：C (骑手位置)
包裹顺序：D(3km) → B(4km) → A(7km)
总距离：3 + 4 + 7 = 14km ✅
预计时间：28分钟 ✅
节省：9km (39%) 和 18分钟 (39%) 🎉
```

---

## 🎯 优化规则总结

### **优先级从高到低：**

1. **⚡ 急送达 + 近距离** - 最高优先级
2. **⏰ 定时达（即将到期）** - 时间紧迫
3. **近距离包裹** - 减少绕路
4. **⏰ 定时达（充足时间）** - 时间充足
5. **✓ 准时达 + 远距离** - 最后配送

### **智能调整：**

- 如果急送达包裹距离稍远（5km），但附近还有普通包裹（3km），系统会：
  - 计算：急送达 5km × 0.5 = **2.5分**
  - 计算：普通 3km × 1.0 = **3.0分**
  - 结果：**优先派送急送达**（分数越低越优先）

- 如果定时达包裹剩余30分钟，系统会：
  - 自动提升优先级（权重 × 0.3）
  - 即使距离较远也会优先派送

---

## 🔍 后台日志监控

在移动应用的控制台中，你可以看到优化日志：

```
🎯 路线优化完成: 
  PKG001 (2.5km, 优先级:1.25)
  PKG002 (3.2km, 优先级:1.92)
  PKG003 (8.5km, 优先级:8.50)

🗺️ 导航 URL: https://www.google.com/maps/dir/?api=1&origin=...
```

---

## 🐛 常见问题

### **Q1: 为什么包裹顺序没有改变？**
**A:** 可能的原因：
1. 只有1个包裹（无需优化）
2. 地理编码失败（检查网络连接）
3. 位置权限未授予

### **Q2: 为什么"急送达"包裹没有排在第一？**
**A:** 算法会综合考虑距离和优先级：
- 如果急送达包裹距离30km，普通包裹距离2km
- 即使有50%权重减免，急送达分数 = 30 × 0.5 = **15**
- 普通包裹分数 = 2 × 1.0 = **2**
- 结果：**仍然优先派送近距离包裹**（避免严重绕路）

### **Q3: 路线规划失败怎么办？**
**A:** 如果优化失败，系统会：
1. 显示错误提示
2. 保持原始包裹顺序
3. 仍然可以手动导航到各个包裹

### **Q4: 如何手动调整顺序？**
**A:** 当前版本暂不支持手动调整。但你可以：
- 点击单个包裹的"导航"按钮，跳过系统建议顺序
- 自行决定配送顺序

---

## 📈 未来优化方向

### **算法优化**
- [ ] 实现完整的 TSP 优化算法（如2-opt、遗传算法）
- [ ] 考虑实时路况和交通拥堵
- [ ] 动态重新规划（配送过程中新增包裹）
- [ ] 多骑手协同优化

### **功能增强**
- [ ] 支持手动拖拽调整顺序
- [ ] 显示预计送达时间（ETA）
- [ ] 路线地图可视化
- [ ] 保存历史最优路线

### **性能优化**
- [ ] 缓存地理编码结果
- [ ] 离线路线规划（基于历史数据）
- [ ] 分批处理大量包裹（>10个）

---

## 📞 技术支持

如有任何问题或建议，请联系技术团队：
- 📧 Email: support@marketlinkexpress.com
- 📱 Phone: 09-000000000

---

## 📚 相关资源

- [Google Maps Directions API](https://developers.google.com/maps/documentation/directions)
- [Haversine Formula](https://en.wikipedia.org/wiki/Haversine_formula)
- [Traveling Salesman Problem](https://en.wikipedia.org/wiki/Travelling_salesman_problem)
- [Nearest Neighbor Algorithm](https://en.wikipedia.org/wiki/Nearest_neighbour_algorithm)

---

**最后更新**：2025-10-12  
**版本**：v1.0.0  
**作者**：ML Express Tech Team 🚀

