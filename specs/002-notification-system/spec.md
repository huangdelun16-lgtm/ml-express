# 功能规范：系统通知功能

## 1. 概述

### 功能描述
为 Market Link Express 添加系统内通知功能，让管理员、经理和员工能够及时收到重要的系统消息和提醒。通知可以是系统自动生成（如包裹状态变更、财务异常），也可以是管理员手动发送的消息。

### 目标用户
- **管理员**：发送全员通知、查看所有通知
- **经理**：发送部门通知、查看相关通知
- **操作员/财务**：接收和查看通知

### 成功标准
- 用户能够在5秒内看到新通知
- 未读通知有明显的视觉标识
- 90%以上的重要通知被用户查看

## 2. 用户故事

### 故事1：管理员发送全员通知
**作为** 管理员  
**我想要** 向所有员工发送系统通知  
**以便** 快速传达重要信息（如系统维护、政策变更）

**场景：发送节假日通知**

**前提条件**：
- 管理员已登录系统
- 拥有管理员权限

**操作步骤**：
1. 进入"系统设置" → "通知管理"
2. 点击"发送通知"按钮
3. 选择接收对象：全员
4. 输入通知标题："国庆节放假通知"
5. 输入通知内容："10月1日-3日系统暂停服务"
6. 选择优先级：高
7. 点击"发送"

**预期结果**：
- 所有在线用户立即收到通知
- 离线用户下次登录时看到通知
- 通知记录保存在数据库
- 审计日志记录发送操作

### 故事2：员工查看通知
**作为** 普通员工  
**我想要** 查看我的未读通知  
**以便** 不错过重要信息

**场景：查看新通知**

**前提条件**：
- 员工已登录系统
- 有新的未读通知

**操作步骤**：
1. 登录系统后看到通知图标有红点
2. 点击通知图标
3. 查看通知列表
4. 点击某条通知查看详情
5. 通知标记为已读

**预期结果**：
- 未读通知数量准确显示
- 通知按时间倒序排列
- 已读通知视觉上有区别
- 可以删除不需要的通知

### 故事3：包裹状态变更自动通知
**作为** 系统  
**我想要** 在包裹状态变更时自动通知相关人员  
**以便** 让团队及时了解包裹进展

**场景：包裹送达自动通知**

**前提条件**：
- 包裹正在配送中
- 快递员更新状态为"已送达"

**操作步骤**：
1. 快递员标记包裹为"已送达"
2. 系统自动创建通知
3. 发送给创建该订单的操作员
4. 发送给财务部门（用于结算）

**预期结果**：
- 相关人员收到通知
- 通知内容包含包裹编号
- 通知可点击跳转到包裹详情
- 审计日志记录自动通知

## 3. 功能需求

### 核心功能

#### 3.1 通知发送
1. **手动发送**
   - 管理员可发送全员通知
   - 经理可发送部门通知
   - 可选择单个或多个接收者
   - 可设置通知优先级（低、中、高、紧急）

2. **自动发送**
   - 包裹状态变更通知
   - 财务异常提醒
   - 系统错误警报
   - 登录异常通知

3. **通知类型**
   - 系统通知（蓝色）
   - 警告通知（橙色）
   - 错误通知（红色）
   - 成功通知（绿色）

#### 3.2 通知接收
1. **通知中心**
   - 查看所有通知列表
   - 筛选（已读/未读、类型、日期）
   - 搜索通知内容
   - 批量标记为已读
   - 删除通知

2. **实时提醒**
   - 导航栏显示通知图标
   - 未读通知数量红点提示
   - 新通知弹窗提示（可关闭）

#### 3.3 通知管理
1. **通知历史**
   - 查看发送历史
   - 查看送达状态
   - 查看阅读状态
   - 导出通知记录

2. **通知设置**
   - 开启/关闭通知提醒
   - 选择接收的通知类型
   - 设置提醒方式

### 界面要求

#### 通知图标（导航栏）
- 位置：右上角用户信息旁边
- 图标：🔔 铃铛图标
- 未读提示：红色数字角标
- 点击：展开通知列表下拉框

#### 通知列表下拉框
- 最多显示5条最新通知
- 每条通知显示：
  - 通知图标（根据类型）
  - 标题（粗体）
  - 内容预览（2行，超出省略）
  - 时间（相对时间，如"5分钟前"）
- 底部按钮："查看全部" → 跳转通知中心

#### 通知中心页面
- 顶部筛选器：全部/未读/已读
- 通知类型标签筛选
- 搜索框
- 通知列表（分页显示）
- 批量操作按钮

#### 发送通知对话框
- 标题输入框
- 内容编辑器（支持换行）
- 接收者选择器（下拉多选）
- 优先级选择
- 类型选择
- 发送/取消按钮

### 数据需求

#### 通知数据
- 通知ID
- 发送者ID和姓名
- 接收者ID列表
- 通知类型（system, warning, error, success）
- 优先级（low, medium, high, urgent）
- 标题
- 内容
- 创建时间
- 是否已读（每个接收者）
- 阅读时间
- 关联对象（如包裹ID、财务ID）

## 4. 非功能需求

### 性能要求
- 通知列表加载 < 500ms
- 发送通知响应 < 1秒
- 支持100+用户同时在线
- 通知历史保留90天

### 安全要求
- 只能查看发给自己的通知
- 只有管理员能发送全员通知
- 通知内容不能包含敏感信息
- 删除通知只是标记，不真删除

### 用户体验
- 新通知有视觉和声音提示（可关闭声音）
- 界面响应式，支持移动端
- 操作简单，2步内完成常用操作
- 错误提示友好明确

### 可访问性
- 支持键盘导航
- 颜色对比度符合标准
- 屏幕阅读器友好

## 5. 约束条件

### 技术约束
- 必须使用 Supabase 数据库
- 前端使用 React + TypeScript
- 遵循现有的设计风格
- 所有操作必须记录审计日志

### 业务约束
- 不发送外部邮件或短信（仅系统内通知）
- 通知不能用于营销推广
- 必须支持中文界面

### 时间约束
- 预计开发时间：3-5天
- 必须在下次版本发布前完成

## 6. 验收标准

### 功能验收
- [ ] 管理员能成功发送全员通知
- [ ] 经理能发送部门通知
- [ ] 普通员工能查看自己的通知
- [ ] 未读通知正确显示数量
- [ ] 通知能标记为已读
- [ ] 通知能被删除
- [ ] 通知中心筛选功能正常
- [ ] 包裹状态变更能自动发送通知

### 权限验收
- [ ] 普通员工不能发送通知
- [ ] 员工只能看到发给自己的通知
- [ ] 管理员能查看所有通知历史

### 性能验收
- [ ] 通知列表加载 < 500ms
- [ ] 100个通知能正常显示
- [ ] 发送通知响应及时

### 审计验收
- [ ] 发送通知操作被记录
- [ ] 删除通知操作被记录
- [ ] 日志包含完整信息

### 用户体验验收
- [ ] 界面美观，符合设计规范
- [ ] 操作流畅，无明显卡顿
- [ ] 错误提示清晰友好
- [ ] 移动端显示正常

---

**创建日期**: 2025-09-30  
**创建者**: 规范驱动开发工作流  
**状态**: 待审核
