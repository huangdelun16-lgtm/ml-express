# 中转码功能工作流程指南

## 功能概述
中转码是包裹在中转站的唯一标识码，用于跟踪包裹在中转站的流转过程。

## 中转码格式
```
TC + 店铺ID前3位 + 包裹ID后4位 + 时间戳后3位
```
**示例**：`TCSTO0293123`
- `TC`：Transfer Code 前缀
- `STO`：店铺ID前3位（如 store001 → STO）
- `0293`：包裹ID后4位（如 MDY2025010800293 → 0293）
- `123`：时间戳后3位

## 工作流程

### 1. 包裹到达中转站
- **触发条件**：骑手将包裹送达中转站
- **状态更新**：包裹状态变为"已送达"
- **记录信息**：记录送达时间和中转站信息
- **中转码**：此时还未生成中转码

### 2. 中转站转发包裹
- **触发条件**：中转站管理员点击"🚚 转发包裹"按钮
- **状态更新**：包裹状态变为"待派送"
- **生成中转码**：自动生成唯一的中转码
- **清除送达时间**：因为包裹还在中转站，不是最终送达
- **用户反馈**：显示成功消息和中转码

### 3. 中转码显示
- **显示位置**：包裹详情卡片中，在送达时间下方
- **显示条件**：只有当包裹有中转码时才显示
- **样式特点**：紫色背景，🔄图标，横跨整行

### 4. 最终配送
- **触发条件**：骑手取件进行最终配送
- **状态更新**：包裹状态变为"已送达"
- **记录送达时间**：记录最终送达时间
- **保留中转码**：中转码继续显示，用于追溯

## 界面设计

### 包裹详情卡片布局
```
[📦 包裹编号]                    [🏪 已到达中转站]
                                [📱 寄件码: SC001]

[🚚 骑手: rider001]  [📅 送达时间: 2025/1/8 14:30:00]
[📏 重量: 2kg]       [💰 费用: ¥3000]

[🔄 中转码: TCSTO0293123]  ← 新增字段

[🚚 转发包裹]
```

### 中转码样式
- **背景色**：`rgba(155, 89, 182, 0.2)` (紫色半透明)
- **边框色**：`rgba(155, 89, 182, 0.3)` (紫色边框)
- **文字色**：`#9b59b6` (紫色)
- **图标**：🔄 (循环箭头)
- **布局**：横跨整行 (`gridColumn: '1 / -1'`)

## 数据库更新

### 1. 添加字段
```sql
ALTER TABLE packages 
ADD COLUMN IF NOT EXISTS transfer_code TEXT;
```

### 2. 添加索引
```sql
CREATE INDEX IF NOT EXISTS idx_packages_transfer_code ON packages(transfer_code);
```

### 3. 验证字段
```sql
SELECT column_name, data_type, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'packages' AND column_name = 'transfer_code';
```

## 测试场景

### 场景1：包裹到达中转站
1. 骑手将包裹送达中转站
2. 包裹状态显示为"🏪 已到达中转站"
3. 中转码字段不显示（还未生成）

### 场景2：转发包裹生成中转码
1. 点击"🚚 转发包裹"按钮
2. 系统生成中转码（如：TCSTO0293123）
3. 包裹状态变为"待派送"
4. 中转码显示在包裹详情中

### 场景3：中转码显示
1. 打开包裹详情
2. 在送达时间下方看到中转码
3. 中转码使用紫色样式，🔄图标

### 场景4：最终配送
1. 骑手取件进行最终配送
2. 包裹状态变为"已送达"
3. 中转码继续显示，用于追溯

## 预期效果

### ✅ 功能特点
- **唯一性**：每个中转码都是唯一的
- **可追溯**：可以追踪包裹在中转站的流转
- **自动生成**：无需手动输入，系统自动生成
- **条件显示**：只有有中转码的包裹才显示
- **样式统一**：与现有设计风格保持一致

### 🎯 业务价值
- **提高效率**：中转站可以快速识别包裹
- **减少错误**：避免包裹混淆
- **增强追溯**：完整的包裹流转记录
- **改善体验**：清晰的状态显示

## 部署步骤

### 1. 数据库更新
在Supabase SQL编辑器中执行：
```sql
-- 复制并执行 add-transfer-code-field.sql 文件中的内容
```

### 2. 代码部署
- 代码已更新并推送到GitHub
- Netlify会自动部署更新

### 3. 功能测试
1. 创建测试包裹
2. 测试中转站功能
3. 验证中转码生成和显示
4. 测试完整工作流程

现在中转码功能已经完全部署好了！🎉
