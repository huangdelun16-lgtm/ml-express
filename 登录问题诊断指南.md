# 🔍 客户端 Web 登录问题诊断指南

## 📋 问题描述

客户端 web 无法登录，显示"该邮箱未注册"，但用户确认之前可以登录。

## 🔍 诊断步骤

### 步骤 1: 使用测试工具检查数据库

1. **打开测试工具**
   - 在浏览器中打开：`test-user-query.html`
   - 或访问：`file:///Users/aungmyatthu/Desktop/ml-express/test-user-query.html`

2. **测试连接**
   - 点击 "1. 测试连接" 按钮
   - 确认可以连接到 Supabase

3. **查询所有用户**
   - 点击 "2. 查询所有用户" 按钮
   - 查看数据库中是否有用户数据
   - **记录**：用户总数和邮箱列表

4. **按邮箱查询**
   - 输入要测试的邮箱（如 `aungmyatthu259369349@gmail.com`）
   - 点击 "3. 按邮箱查询" 按钮
   - **记录**：查询结果和错误信息

5. **检查表结构**
   - 点击 "4. 检查表结构" 按钮
   - **记录**：字段列表

---

### 步骤 2: 检查 Supabase Dashboard

1. **登录 Supabase Dashboard**
   - 访问：https://app.supabase.com
   - 选择项目：`uopkyuluxnrewvlmutam`

2. **检查 users 表**
   - 进入 **Table Editor** → **users**
   - 查看是否有用户数据
   - **检查**：
     - 邮箱字段名称是否正确（`email`）
     - 邮箱格式是否正确
     - `user_type` 字段值是什么

3. **检查 RLS 策略**
   - 进入 **Authentication** → **Policies**
   - 找到 `users` 表
   - **检查策略**：
     ```sql
     -- 应该有这样的策略允许查询
     CREATE POLICY "Allow all operations on users" ON users
     FOR ALL USING (true) WITH CHECK (true);
     ```
   - 如果没有，需要创建或修改策略

---

### 步骤 3: 检查环境变量

1. **检查 Netlify 环境变量**
   - 登录 Netlify Dashboard
   - 进入 **Site settings** → **Environment variables**
   - **确认**以下变量已配置：
     - `REACT_APP_SUPABASE_URL`
     - `REACT_APP_SUPABASE_ANON_KEY`

2. **检查环境变量值**
   - 确认 URL 正确：`https://uopkyuluxnrewvlmutam.supabase.co`
   - 确认 Key 正确（Anon Key，不是 Service Role Key）

---

## 🛠️ 可能的解决方案

### 方案 1: RLS 策略问题

**症状**：测试工具可以查询到用户，但网站无法查询

**解决**：在 Supabase Dashboard 中检查并修复 RLS 策略

```sql
-- 如果策略不存在，创建它
CREATE POLICY "Allow all operations on users" ON users
FOR ALL USING (true) WITH CHECK (true);

-- 如果策略存在但有问题，删除后重新创建
DROP POLICY IF EXISTS "Allow all operations on users" ON users;
CREATE POLICY "Allow all operations on users" ON users
FOR ALL USING (true) WITH CHECK (true);
```

---

### 方案 2: 数据库表结构变化

**症状**：表结构中的字段名称或类型发生了变化

**检查**：
1. 在 Supabase Dashboard 中查看 `users` 表结构
2. 确认以下字段存在：
   - `id` (TEXT)
   - `email` (TEXT)
   - `user_type` (TEXT)
   - `password` (TEXT)
   - `name` (TEXT)

**修复**：如果字段缺失，需要添加字段或修改代码

---

### 方案 3: 数据迁移问题

**症状**：用户数据在其他表中，或邮箱格式不同

**检查**：
1. 检查是否有其他用户表（如 `customers`）
2. 检查邮箱字段是否有额外的空格或特殊字符
3. 检查邮箱是否区分大小写

**修复**：
- 如果数据在其他表，需要修改查询代码
- 如果邮箱格式不同，需要数据清理

---

### 方案 4: 环境变量未生效

**症状**：本地可以查询，但部署后无法查询

**解决**：
1. 确认 Netlify 环境变量已配置
2. 重新部署站点（环境变量更改后需要重新部署）
3. 清除浏览器缓存

---

## 📝 调试信息收集

请提供以下信息以便进一步诊断：

1. **测试工具结果**
   - 连接测试结果
   - 所有用户查询结果
   - 按邮箱查询结果

2. **Supabase Dashboard 信息**
   - users 表中的用户数量
   - 示例用户的邮箱格式
   - RLS 策略列表

3. **浏览器控制台日志**
   - 完整的查询日志
   - 任何错误信息

---

## 🔧 快速修复脚本

如果确认是 RLS 策略问题，可以在 Supabase Dashboard 的 SQL Editor 中执行：

```sql
-- 1. 检查当前策略
SELECT * FROM pg_policies WHERE tablename = 'users';

-- 2. 删除旧策略（如果存在）
DROP POLICY IF EXISTS "Allow all operations on users" ON users;
DROP POLICY IF EXISTS "Users can view own data" ON users;
DROP POLICY IF EXISTS "Public can read users" ON users;

-- 3. 创建允许所有操作的策略（开发/测试环境）
CREATE POLICY "Allow all operations on users" ON users
FOR ALL USING (true) WITH CHECK (true);

-- 4. 验证策略已创建
SELECT * FROM pg_policies WHERE tablename = 'users';
```

---

## ⚠️ 安全提醒

**注意**：`USING (true) WITH CHECK (true)` 策略允许所有操作，适合开发环境，但生产环境应该使用更严格的策略。

生产环境建议的策略：

```sql
-- 允许匿名用户读取客户数据（用于登录验证）
CREATE POLICY "Allow anon read customers" ON users
FOR SELECT USING (user_type = 'customer');

-- 允许匿名用户插入客户数据（用于注册）
CREATE POLICY "Allow anon insert customers" ON users
FOR INSERT WITH CHECK (user_type = 'customer');
```

---

## 📞 需要帮助？

如果以上步骤都无法解决问题，请提供：
1. 测试工具的完整输出
2. Supabase Dashboard 中的表结构和策略截图
3. 浏览器控制台的完整日志

这样我可以更准确地定位问题。

