# ML Express 核心业务逻辑架构

## 系统概述

ML Express 的核心业务逻辑确保客户端和骑手端应用与Web后台系统无缝对接，提供实时、可靠、高效的快递服务体验。

## 1. 实时订单同步系统 ✅

### 架构设计
```
Web后台 ←→ WebSocket/Socket.IO ←→ Android客户端
    ↓                                    ↓
MySQL数据库                         Room本地数据库
```

### 核心组件

#### **RealtimeOrderSyncService**
- **功能**: 维持与Web后台的实时连接
- **技术**: Socket.IO客户端 + 前台服务
- **特性**:
  - 自动重连机制（指数退避）
  - 心跳检测（30秒间隔）
  - 数据冲突解决
  - 离线消息缓存

#### **WebSocketManager**
- **连接管理**: 智能连接/断开策略
- **事件处理**: 订单创建、更新、状态变更、分配
- **错误恢复**: 网络异常自动恢复
- **性能优化**: 根据网络质量调整重连策略

### 数据同步流程
```
1. 客户下单 → Web后台 → WebSocket推送 → 所有在线骑手
2. 骑手接单 → 骑手端 → Web后台 → WebSocket推送 → 客户端
3. 状态更新 → 任一端 → Web后台 → 实时同步 → 其他端
4. 位置更新 → 骑手端 → Web后台 → 实时推送 → 客户端
```

### 冲突解决策略
- **时间戳优先**: 最新时间戳的数据优先
- **服务器权威**: 关键业务数据以服务器为准
- **本地优先**: 用户输入数据优先保留
- **合并策略**: 非冲突字段智能合并

## 2. 位置跟踪系统 ✅

### 架构设计
```
骑手端GPS → LocationTrackingService → Web后台 → 客户端实时显示
     ↓                    ↓                ↓
本地位置缓存        位置数据优化        地理围栏检测
```

### 核心组件

#### **LocationTrackingService**
- **后台定位**: 前台服务保证持续运行
- **智能频率**: 根据电量和网络状态调整
- **数据优化**: 位置变化阈值过滤
- **省电模式**: 多级省电策略

#### **PowerOptimizationManager**
- **电量监控**: 实时监控电池状态
- **性能调节**: 动态调整服务频率
- **后台优化**: 应用前后台状态感知
- **内存管理**: 智能内存清理

### 位置跟踪模式
```kotlin
enum class LocationTrackingMode {
    NORMAL(10秒, 10米),      // 正常模式
    BACKGROUND(30秒, 20米),   // 后台模式
    BATTERY_SAVE(1分钟, 50米), // 省电模式
    POWER_SAVE(5分钟, 100米)   // 超省电模式
}
```

### 地理围栏功能
- **到达检测**: 自动检测骑手到达取件/送件地点
- **范围设置**: 可配置的到达半径（默认50米）
- **通知触发**: 到达时自动通知客户
- **状态同步**: 实时更新订单状态

## 3. 推送通知系统 ✅

### 架构设计
```
Web后台 → Firebase Admin SDK → FCM → Android客户端
    ↓                              ↓
业务逻辑触发                    本地通知处理
```

### 通知类型分类

#### **客户端通知**
- **订单状态**: 确认、取件、运输中、已送达
- **配送员信息**: 分配配送员、联系方式
- **位置更新**: 配送员实时位置
- **系统消息**: 促销、公告、维护通知

#### **骑手端通知**
- **新订单推送**: 高优先级、震动、声音
- **紧急订单**: 最高优先级、强制提醒
- **收入更新**: 订单完成收入到账
- **系统消息**: 政策更新、培训通知

### 通知优化策略
- **智能分组**: 相同类型通知合并显示
- **优先级管理**: 紧急通知优先展示
- **免打扰模式**: 用户可设置免打扰时间
- **离线缓存**: 离线时缓存通知，上线后推送

## 4. 支付集成系统 ✅

### 支持的支付方式

#### **现金支付 (Cash on Delivery)**
- **流程**: 订单创建 → 配送 → 现场收款 → 确认支付
- **验证**: 配送员拍照确认收款
- **结算**: 配送员与平台结算

#### **移动支付集成**
- **KBZ Pay**: 缅甸最大移动支付平台
- **Wave Money**: 主流移动钱包
- **CB Pay**: CB银行移动支付
- **AYA Pay**: AYA银行移动支付

### 支付流程

#### **预支付流程**
```
1. 用户选择支付方式 → 调用支付API
2. 获取支付链接/二维码 → 跳转支付应用
3. 完成支付 → 回调验证 → 更新订单状态
4. 支付确认 → 通知配送员 → 开始配送
```

#### **货到付款流程**
```
1. 订单创建 → 标记货到付款
2. 配送员送达 → 收取现金
3. 拍照确认 → 更新支付状态
4. 平台结算 → 配送员收入入账
```

### 支付安全
- **加密传输**: HTTPS + SSL证书
- **Token验证**: JWT访问令牌
- **签名验证**: API请求签名
- **风控检测**: 异常交易监控

## 5. 网络状态处理 ✅

### 网络监控
```kotlin
NetworkMonitor {
    - 实时网络状态监控
    - 网络类型检测（WiFi/4G/5G）
    - 网络质量评估
    - 连接状态变化通知
}
```

### 离线模式支持
- **数据缓存**: 关键数据本地存储
- **操作队列**: 离线操作排队等待
- **自动同步**: 网络恢复后自动同步
- **冲突解决**: 智能数据冲突处理

### 网络优化策略
- **请求合并**: 批量API请求
- **缓存优先**: 智能缓存策略
- **超时控制**: 根据网络质量调整超时
- **重试机制**: 指数退避重试

## 6. 数据一致性保障 ✅

### 数据同步策略

#### **双向同步**
```
客户端 ←→ Web后台 ←→ 骑手端
   ↓         ↓         ↓
Room DB   MySQL DB   Room DB
```

#### **冲突解决**
- **最后写入胜利**: 时间戳较新的数据优先
- **业务规则优先**: 关键业务状态不可逆转
- **用户确认**: 重要冲突需要用户确认
- **服务器仲裁**: 复杂冲突由服务器决定

### 数据版本控制
- **版本号**: 每次数据更新增加版本号
- **变更日志**: 记录所有数据变更
- **回滚机制**: 支持数据回滚操作
- **审计跟踪**: 完整的操作审计日志

## 7. 性能优化策略 ✅

### 电量优化

#### **多级省电模式**
```kotlin
正常模式: 10秒定位 + 实时同步
后台模式: 30秒定位 + 降频同步  
省电模式: 1分钟定位 + 最小同步
超省电: 5分钟定位 + 暂停非必要功能
```

#### **智能调度**
- **电量感知**: 根据电量调整服务频率
- **充电检测**: 充电时恢复正常频率
- **前后台感知**: 应用状态智能切换
- **用户行为**: 根据使用模式优化

### 内存优化
- **对象池**: 重用频繁创建的对象
- **懒加载**: 按需加载数据和资源
- **缓存策略**: LRU缓存 + 定期清理
- **内存监控**: 实时监控内存使用

### 网络优化
- **请求缓存**: HTTP缓存 + 本地缓存
- **数据压缩**: Gzip压缩传输
- **连接复用**: HTTP/2 + 连接池
- **CDN加速**: 静态资源CDN分发

## 8. 安全和可靠性 ✅

### 数据安全
- **传输加密**: TLS 1.3 + 证书绑定
- **存储加密**: 敏感数据AES加密
- **访问控制**: 基于角色的权限控制
- **审计日志**: 完整的操作审计

### 服务可靠性
- **健康检查**: 定期服务健康检测
- **自动恢复**: 服务异常自动重启
- **降级策略**: 服务不可用时的降级方案
- **监控告警**: 实时监控和告警

### 错误处理
- **全局异常**: 统一异常处理机制
- **用户友好**: 友好的错误提示
- **错误上报**: 自动错误收集和上报
- **快速恢复**: 错误后快速恢复策略

## 9. 与Web后台对接规范 ✅

### API接口规范
```kotlin
// 统一响应格式
{
    "success": true,
    "data": {...},
    "message": "操作成功",
    "timestamp": "2024-12-19T12:00:00Z"
}

// 错误响应格式
{
    "success": false,
    "error": {
        "code": "ORDER_NOT_FOUND",
        "message": "订单不存在",
        "details": {...}
    }
}
```

### 认证机制
- **JWT Token**: 访问令牌 + 刷新令牌
- **自动刷新**: Token过期自动刷新
- **安全存储**: 加密存储在本地
- **会话管理**: 统一会话生命周期

### 数据格式标准
- **时间格式**: ISO 8601 (UTC)
- **货币格式**: 整数表示（分为单位）
- **坐标格式**: WGS84坐标系
- **状态枚举**: 统一状态定义

## 10. 部署和监控 ✅

### 服务部署
```yaml
# 后台服务配置
services:
  - api_server: Node.js + Express
  - websocket_server: Socket.IO
  - database: MySQL 8.0
  - redis: 缓存和会话
  - nginx: 负载均衡和SSL
```

### 监控指标
- **连接状态**: WebSocket连接成功率
- **同步延迟**: 数据同步平均延迟
- **错误率**: API请求错误率
- **性能指标**: 响应时间、吞吐量
- **用户体验**: 崩溃率、ANR率

### 告警机制
- **服务异常**: 服务宕机立即告警
- **数据异常**: 数据不一致告警
- **性能异常**: 响应时间超阈值告警
- **用户异常**: 大量用户错误告警

## 技术特色总结

### 🚀 **实时性**
- **毫秒级响应**: WebSocket实时通信
- **智能推送**: 基于位置的智能订单推送
- **实时跟踪**: 配送员位置实时更新
- **即时反馈**: 操作结果即时反馈

### 🔄 **可靠性**
- **多重备份**: 本地缓存 + 服务器存储
- **自动恢复**: 服务异常自动重启
- **数据一致**: 强一致性保证
- **容错处理**: 完善的异常处理

### ⚡ **高性能**
- **智能缓存**: 多级缓存策略
- **按需加载**: 懒加载和预加载结合
- **资源优化**: CPU、内存、电量全面优化
- **网络优化**: 请求合并和压缩传输

### 🛡️ **安全性**
- **端到端加密**: 数据传输全程加密
- **权限控制**: 细粒度权限管理
- **审计跟踪**: 完整操作审计
- **隐私保护**: 用户隐私严格保护

### 🌍 **本地化**
- **多语言**: 英语、缅甸语、中文
- **本地支付**: 集成缅甸主流支付方式
- **文化适配**: 符合本地使用习惯
- **法规遵循**: 遵守当地法律法规

## 核心业务流程

### 📱 **完整订单流程**
```
1. 客户下单 → 实时推送给附近骑手
2. 骑手抢单 → 实时通知客户分配结果
3. 骑手取件 → 实时更新订单状态
4. 运输过程 → 实时位置跟踪
5. 送达确认 → 支付处理 → 订单完成
6. 评价反馈 → 数据统计 → 系统优化
```

### 💰 **支付处理流程**
```
1. 支付方式选择 → 调用对应支付接口
2. 支付处理 → 状态实时同步
3. 支付确认 → 更新订单状态
4. 异常处理 → 自动退款流程
5. 收入结算 → 平台和骑手分成
```

### 🔄 **数据同步流程**
```
1. 数据变更 → 本地数据库更新
2. 网络检测 → 选择同步策略
3. 实时同步 → WebSocket推送
4. 冲突检测 → 智能冲突解决
5. 确认同步 → 所有端数据一致
```

## 部署和集成

### 客户端集成
```kotlin
// 在Application中初始化
class MLExpressApplication : Application() {
    @Inject lateinit var mlExpressCore: MLExpressCore
    
    override fun onCreate() {
        super.onCreate()
        mlExpressCore.initialize()
    }
}
```

### 服务器端配置
```javascript
// Node.js + Socket.IO服务器
const io = require('socket.io')(server, {
    cors: { origin: "*" },
    transports: ['websocket', 'polling']
});

io.use(authenticateSocket);
io.on('connection', handleSocketConnection);
```

### 数据库同步
```sql
-- 订单表触发器（MySQL）
DELIMITER //
CREATE TRIGGER order_update_trigger 
AFTER UPDATE ON orders
FOR EACH ROW
BEGIN
    INSERT INTO order_sync_queue (order_id, action, timestamp)
    VALUES (NEW.id, 'UPDATE', NOW());
END//
```

## 监控和维护

### 关键指标
- **连接成功率**: >99%
- **数据同步延迟**: <2秒
- **位置更新频率**: 10-60秒
- **推送到达率**: >95%
- **支付成功率**: >98%

### 故障处理
- **自动重试**: 网络异常自动重试
- **降级服务**: 关键服务不可用时降级
- **手动干预**: 严重故障人工处理
- **快速恢复**: 故障恢复后快速同步

---

**这套核心业务逻辑架构确保了ML Express应用的高可用性、实时性和用户体验，为缅甸本地快递服务提供了坚实的技术基础。** 🚀📱⚡

## 技术支持
- **架构咨询**: architecture@mlexpress.com
- **集成支持**: integration@mlexpress.com  
- **运维支持**: ops@mlexpress.com
