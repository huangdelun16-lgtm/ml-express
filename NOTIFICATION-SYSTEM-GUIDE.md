# 📲 包裹分配通知系统使用指南

## 📋 功能概述

当Web后台管理系统将包裹分配给快递员时，骑手会在移动应用中收到实时通知提醒。

---

## 🎯 实现功能

### ✅ **1. 数据库通知表**
- 创建了 `notifications` 表用于存储通知记录
- 支持多种通知类型：包裹分配、状态更新、紧急通知、系统通知
- 包含完整的已读/未读状态跟踪
- 启用了行级安全策略(RLS)保护数据

### ✅ **2. Web 端通知发送**
- **位置**：`src/pages/RealTimeTracking.tsx` - "实时跟踪管理"页面
- **触发时机**：
  - 🤖 自动分配包裹时
  - 👤 手动分配包裹时
- **通知内容**：
  - 📋 包裹编号
  - 📤 寄件人信息
  - 📥 收件人信息
  - 📍 送达地址
  - ⏱️ 配送速度（准时达/急送达/定时达）

### ✅ **3. 移动端通知接收**
- **位置**：`ml-express-mobile-app/screens/DashboardScreen.tsx`
- **轮询机制**：每30秒自动检查新通知
- **通知展示**：
  - 弹出 Alert 对话框显示完整通知内容
  - 提供"稍后查看"和"立即查看"两个选项
  - 点击"立即查看"会自动标记为已读并跳转到包裹管理页面
- **未读计数**：实时显示未读通知数量

---

## 🚀 使用步骤

### **第一步：在 Supabase 中创建通知表**

1. 登录 [Supabase Dashboard](https://app.supabase.com/)
2. 选择你的项目
3. 进入 **SQL Editor**
4. 复制并执行 `supabase-notifications-setup.sql` 中的所有SQL语句
5. 执行成功后，你会看到 `notifications` 表已创建

### **第二步：启用通知功能（系统设置）**

1. 登录 Web 后台管理系统
2. 进入 **"系统设置中心"** → **"通知中心"**
3. 确保以下设置已开启：
   - ✅ **启用短信通知** (`notification.sms_enabled`)
   - ✅ **启用邮件通知** (`notification.email_enabled`)

> 💡 **注意**：如果通知功能未启用，系统会跳过发送通知（不会报错）

### **第三步：测试通知流程**

#### **A. 在 Web 端分配包裹**
1. 登录 Web 后台管理系统
2. 进入 **"实时跟踪管理"**
3. 确保有快递员在线（状态显示为"在线"🟢）
4. 点击待分配的包裹卡片
5. 选择 **"分配包裹"**
6. 选择一个在线的快递员
7. 点击 **"确认分配"**
8. 看到提示：`包裹 XXX 已成功分配给快递员 XXX 📲 通知已发送`

#### **B. 在移动端接收通知**
1. 在手机上打开 **ML Express 移动应用**
2. 使用快递员账号登录
3. 进入 **首页（Dashboard）**
4. **等待最多30秒**（自动轮询）
5. 会弹出通知对话框：
   ```
   📦 新包裹分配通知
   
   您好 XXX，系统已为您分配新包裹！
   
   📋 包裹编号：PKG123456
   📤 寄件人：张三
   📥 收件人：李四
   📍 送达地址：仰光市中心XXX路123号
   ⏱️ 配送速度：⚡ 急送达
   
   请及时取件并开始配送！
   ```
6. 可以选择：
   - **"稍后查看"**：关闭通知，通知保留为未读
   - **"立即查看"**：标记为已读，跳转到包裹管理页面

---

## 🔧 技术实现细节

### **通知轮询机制**
```typescript
// 每30秒检查一次新通知
const notificationInterval = setInterval(async () => {
  await checkForNewNotifications();
}, 30 * 1000);
```

### **通知对比逻辑**
- 每次轮询时对比当前未读数量与上次的数量
- 如果 `当前未读数 > 上次未读数`，说明有新通知
- 立即获取最新的通知并弹出 Alert

### **数据库查询优化**
- 使用索引加速查询：`idx_notifications_recipient`
- 只查询 `recipient_type = 'courier'` 的通知
- 按 `created_at` 降序排列，获取最新通知

---

## 📊 系统设置说明

### **通知相关设置（系统设置中心 → 通知中心）**

| 设置项 | 键值 | 说明 |
|--------|------|------|
| 启用短信通知 | `notification.sms_enabled` | 开启后发送通知 |
| 启用邮件通知 | `notification.email_enabled` | 开启后发送通知 |
| 客户通知模板 | `notification.customer_template` | 自定义客户通知内容 |
| 内部通知模板 | `notification.internal_template` | 自定义内部通知内容 |

> 💡 **提示**：只要 `sms_enabled` 或 `email_enabled` 任一启用，通知功能就会生效

---

## 🧪 测试清单

### **✅ 测试前准备**
- [ ] Supabase 中 `notifications` 表已创建
- [ ] Web 端已部署最新代码
- [ ] 移动端已安装最新版本
- [ ] 系统设置中通知功能已启用
- [ ] 至少有一个快递员账号已登录移动端

### **✅ 功能测试**
1. **自动分配测试**
   - [ ] 在 Web 端点击"自动分配"
   - [ ] 移动端30秒内收到通知
   - [ ] 通知内容完整准确
   
2. **手动分配测试**
   - [ ] 在 Web 端手动选择快递员分配
   - [ ] 移动端30秒内收到通知
   - [ ] 通知内容完整准确

3. **已读状态测试**
   - [ ] 点击"立即查看"后通知标记为已读
   - [ ] 未读数量减1
   - [ ] 再次打开应用不会重复提示

4. **多通知测试**
   - [ ] 连续分配多个包裹
   - [ ] 每个包裹都能收到独立通知
   - [ ] 未读数量正确累加

---

## 🐛 常见问题

### **Q1: 为什么没有收到通知？**
**A:** 请检查以下几点：
1. ✅ Supabase 中 `notifications` 表是否已创建
2. ✅ 系统设置中通知功能是否已启用
3. ✅ 快递员是否已登录移动应用
4. ✅ 是否在首页（Dashboard）等待了至少30秒
5. ✅ 查看手机通知权限是否已授予

### **Q2: 通知延迟太长怎么办？**
**A:** 当前轮询间隔为30秒。如需更快响应，可以修改：
```typescript
// 在 DashboardScreen.tsx 中修改间隔为10秒
const notificationInterval = setInterval(async () => {
  await checkForNewNotifications();
}, 10 * 1000); // 改为10秒
```

### **Q3: 如何查看历史通知？**
**A:** 当前版本通知会自动弹出。未来版本会添加"通知中心"页面供查看历史记录。

### **Q4: 通知能否发送到手机系统通知栏？**
**A:** 当前版本使用 Alert 弹窗。如需推送到系统通知栏，需要：
1. 集成 Expo Notifications
2. 配置 FCM (Firebase Cloud Messaging)
3. 申请 APNs 证书（iOS）

---

## 📈 未来优化方向

### **🚀 功能增强**
- [ ] 添加"通知中心"页面查看历史通知
- [ ] 支持系统原生推送通知（FCM/APNs）
- [ ] 通知分类过滤（包裹分配/状态更新/紧急通知）
- [ ] 通知音效和振动提醒
- [ ] 批量标记已读功能

### **⚡ 性能优化**
- [ ] 使用 Supabase Realtime 替代轮询
- [ ] 实现 WebSocket 长连接
- [ ] 通知缓存机制
- [ ] 离线通知队列

### **🎨 体验优化**
- [ ] 自定义通知铃声
- [ ] 通知免打扰时段设置
- [ ] 通知重要性分级
- [ ] 通知预览样式优化

---

## 📞 技术支持

如有任何问题，请联系技术团队：
- 📧 Email: marketlink982@gmail.com
- 📱 Phone: (+95) 09788848928 / (+95) 09259369349

---

**最后更新**：2025-10-12  
**版本**：v1.0.0  
**作者**：ML Express Tech Team

